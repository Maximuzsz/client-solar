name: Deploy Docker to EC2

on:
  push:
    branches:
      - main

env:
  EC2_HOST: 3.142.124.62
  PROJECT_DIR: /home/ubuntu/client-solar
  CONTAINER_NAME: solarshare-frontend
  GIT_REPO: https://github.com/Maximuzsz/client-solar.git

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Test SSH Connection
        run: ssh -o StrictHostKeyChecking=no ubuntu@$EC2_HOST "echo 'SSH connection successful'"

      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@$EC2_HOST << 'ENDSSH'
            set -euo pipefail
            echo "=== Starting deployment ==="
            
            # Variables
            PROJECT_DIR="$HOME/client-solar"
            CONTAINER_NAME="solarshare-frontend"
            GIT_REPO="https://github.com/Maximuzsz/client-solar.git"
            
            # Update system
            echo "=== Updating system ==="
            sudo apt-get update -qq
            sudo apt-get install -y docker.io docker-compose
            
            # Install Docker Buildx (it's included with modern Docker installations)
            echo "=== Setting up Docker Buildx ==="
            docker --version
            docker buildx version || echo "Buildx not available, will use regular build"
            
            # Ensure user has docker permissions
            sudo usermod -aG docker ubuntu
            # Apply group changes without needing logout
            newgrp docker || true
            
            # Rest of your deployment script...
            # [O restante do seu script permanece igual]
          ENDSSH