name: Deploy Docker to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Deploy to EC2
        env:
          HOST: 3.142.124.62
          USER: ubuntu
          PROJECT_DIR: /home/ubuntu/client-solar
          IMAGE_NAME: solarshare-frontend
          CONTAINER_NAME: solarshare-frontend
          GIT_REPO: your-git-repo-url.git  # Add your actual Git repository URL here
        run: |
          ssh -o StrictHostKeyChecking=no $USER@$HOST /bin/bash << 'EOF'
            set -e  # Exit script if any command fails
            
            echo "üìÅ Acessando/Criando diret√≥rio do projeto..."
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"

            if [ ! -d .git ]; then
              echo "üì• Clonando reposit√≥rio..."
              git clone "$GIT_REPO" .
            else
              echo "üì• Atualizando reposit√≥rio..."
              git reset --hard
              git pull origin main
            fi

            echo "üßπ Limpando containers antigos..."
            docker stop "$CONTAINER_NAME" 2>/dev/null || true
            docker rm "$CONTAINER_NAME" 2>/dev/null || true

            echo "üê≥ Construindo imagem Docker..."
            docker build -t "$IMAGE_NAME" .

            echo "üöÄ Iniciando container..."
            docker run -d \
              --name "$CONTAINER_NAME" \
              -p 80:80 \
              --restart unless-stopped \
              "$IMAGE_NAME"

            echo "‚úÖ Deploy conclu√≠do com sucesso!"
          EOF